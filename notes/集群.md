# 集群🌊

## 从单机到集群

集群（cluster），是指同一种组件的多个实例，形成的逻辑上的整体。

单机处理到达瓶颈的时候，把单机复制几份，这样就构成了一个 "集群" 。 集群中每台服务器就叫做这个集群的一个 "节点" ，所有节点构成了一个集群。每个节点都提供相同的服务，那么这样系统的处理能力就相当于提升了好几倍。

但用户的请求终究要通过某个节点来处理，最好能够让此时此刻负载较小的节点来处理，这样使得每个节点的压力都比较平均。要实现这个功能，就需要在所有节点之前增加一个 "调度者" 的角色，用户的所有请求都先交给它，然后它根据当前所有节点的负载情况，决定将这个请求交给哪个节点处理。这个 "调度者" 就是负载均衡服务器。



## 从集群到分布式

集群结构的好处就是系统扩展非常容易。如果随着系统业务的发展，当前的系统又支撑不住了，那么给这个集群再增加节点就行了。但是，当业务发展到一定程度的时候，会发现无论怎么增加节点，整个集群性能的提升效果并不明显了。这时候，就需要使用分布式（distributed）结构了。

分布式结构就是将一个完整的系统，按照业务功能，拆分成一个个独立的子系统，在分布式结构中，每个子系统就被称为 "服务" 。这些子系统能够独立运行在 web 容器中，它们之间通过 RPC 方式通信。



# 负载均衡🌊

负载均衡（Load Balance），其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如FTP服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。

集群，是指同一种组件的多个实例，形成的逻辑上的整体。集群中的应用服务器（节点）通常被设计成无状态，用户可以请求任何一个节点。

负载均衡器会根据集群中每个节点的负载情况，将用户请求转发到合适的节点上。

负载均衡器可以用来实现高可用以及伸缩性：

- 高可用：当某个节点故障时，负载均衡器会将用户请求转发到另外的节点上，从而保证所有服务持续可用；
- 伸缩性：根据系统整体负载情况，可以很容易地添加或移除节点。

负载均衡器运行过程包含两个部分：

- 根据负载均衡算法得到转发的节点

- 进行转发。



## 负载均衡的类型

### DNS实现负载均衡

DNS 实现负载均衡是最基础简单的方式。一个域名通过 DNS 解析到多个 IP，每个 IP 对应不同的服务器实例，这样就完成了流量的调度，虽然没有使用常规的负载均衡器，但实现了简单的负载均衡功能。

<img src="http://store.secretcamp.cn/uPic/image-20210313210333697202103132103331615640613UQZ2XcUQZ2Xc.png" alt="image-20210313210333697" style="zoom:50%;" />





### 硬件负载均衡







### 软件负载均衡



软件负载均衡，可以在普通的服务器上运行负载均衡软件，实现负载均衡功能。目前常见的有 `Nginx`、`HAproxy`、`LVS`。其中的区别：

- `Nginx`：七层负载均衡，支持 HTTP、E-mail 协议，同时也支持 4 层负载均衡；
- `HAproxy`：支持七层规则的，性能也很不错。OpenStack 默认使用的负载均衡软件就是 HAproxy；
- `LVS`：运行在内核态，性能是软件负载均衡中最高的，严格来说工作在三层，所以更通用一些，适用各种应用服务。

软件负载均衡的优点：

- 易操作：无论是部署还是维护都相对比较简单；
- 便宜：只需要服务器的成本，软件是免费的；
- 灵活：4 层和 7 层负载均衡可以根据业务特点进行选择，方便进行扩展和定制功能。





## 负载均衡算法

### 轮询

轮询（Round Robin）算法把每个请求轮流发送到每个服务器上。

下图中，一共有6个客户端产生了6个请求，这6个请求按 [1, 2, 3, 4, 5, 6] 的顺序发送。[1, 3, 5] 的请求会被发送到 Server-1，[2, 4, 6] 的请求会被发送到 Server-2。

<img src="http://store.secretcamp.cn/uPic/image-20210314093239132202103140932391615685559dnaBnPdnaBnP.png" alt="image-20210314093239132" style="zoom: 50%;" />

该算法比较适合每个服务器的性能差不多的场景，如果有性能存在差异的情况下，那么性能较差的服务器可能无法承担过大的负载，如下图中的 Server-2 。

<img src="http://store.secretcamp.cn/uPic/image-20210314093414552202103140934141615685654EgxIGuEgxIGu.png" alt="image-20210314093414552" style="zoom:48%;" />



### 加权轮询

加权轮询（Weighted Round Robbin）是在轮询的基础上，根据服务器的性能差异，为服务器赋予一定的权值，性能高的服务器分配更高的权值。

例如下图中，Server-1 被赋予的权值为5，Server-2 被赋予的权值为1，那么 [1, 2, 3, 4, 5] 请求会被发送到 Server-1，[6] 请求会被发送到 Server-2 。

<img src="http://store.secretcamp.cn/uPic/image-2021031409381245620210314093812161568589284fwZB84fwZB.png" alt="image-20210314093812456" style="zoom:50%;" />

### 最少连接

最少连接（least Connections）算法就是将请求发送给当前最少连接数的服务器上。

例如下图中，Server-1 当前连接数最小，那么新到来的请求6 就会被发送到 Server-1 上。

<img src="http://store.secretcamp.cn/uPic/image-20210314093921385202103140939211615685961IuoFJLIuoFJL.png" alt="image-20210314093921385" style="zoom:50%;" />



### 加权最少连接

加权最少连接（Weighted Least Connection）是在最少连接的基础上，根据服务器的性能为每台服务器分配权重，再根据权重计算出每台服务器能处理的连接数。



### 随机算法

随机（Random）算法把请求随机发送到服务器上。

和轮询算法类似，该算法比较适合服务器性能差不多的场景。





### 源地址哈希法 (IP Hash)

源地址哈希通过对客户端 IP 计算哈希值之后，再对服务器数量取模得到目标服务器的序号。

可以保证同一 IP 的客户端的请求会转发到同一台服务器上，用来实现会话粘滞（Sticky Session）



## 转发实现

### HTTP重定向

HTTP重定向负载均衡服务器使用某种负载均衡算法计算得到服务器的IP地址之后，将该地址写入HTTP重定向报文中，状态码为 302，客户端收到重定向报文之后，需要重新向服务器发起请求。

缺点：

- 需要两次请求，因此访问延迟比较高；
- HTTP负载均衡器处理能力有限，会限制集群的规模。

该负载均衡转发的缺点比较明显，实际场景中很少使用它

<img src="http://store.secretcamp.cn/uPic/image-20210314094631203202103140946311615686391dE2zAidE2zAi.png" alt="image-20210314094631203" style="zoom:50%;" />



### DNS域名解析

在DNS解析域名的同时使用负载均衡算法计算服务器IP地址。

优点：

- DNS 能够根据地理位置进行域名解析，返回离用户最近的服务器IP地址。

缺点：

- 由于DNS具有多级结构，每一级的域名记录都可能被缓存，当下线一台服务器需要修改DNS记录时，需要过很长一段时间才能生效。

大型网站基本使用了DNS做为第一级负载均衡手段，然后在内部使用其它方式做第二级负载均衡。也就是说，域名解析的结果为内部的负载均衡服务器IP地址。





### 反向代理服务器

反向代理服务器位于源服务器前面，用户的请求需要先经过反向代理服务器才能到达源服务器。反向代理可以用来进行缓存、日志记录等，同时也可以用来做为负载均衡服务器。

在这种负载均衡转发方式下，客户端不直接请求源服务器，因此源服务器不需要外部IP地址，而反向代理需要配置内部和外部两套IP地址。

优点：

- 与其它功能集成在一起，部署简单。

缺点：

- 所有请求和响应都需要经过反向代理服务器，它可能会成为性能瓶颈。



### 网络层

在操作系统内核进程获取网络数据包，根据负载均衡算法计算源服务器的IP地址，并修改请求数据包的目的IP地址，最后进行转发。

源服务器返回的响应也需要经过负载均衡服务器，通常是让负载均衡服务器同时作为集群的网关服务器来实现。

优点：

- 在内核进程中进行处理，性能比较高。

缺点：

- 和反向代理一样，所有的请求和响应都经过负载均衡服务器，会成为性能瓶颈。



### 链路层

在链路层根据负载均衡算法计算源服务器的MAC地址，并修改请求数据包的目的MAC地址，并进行转发。

通过配置源服务器的虚拟IP地址和负载均衡服务器的IP地址一致，从而不需要修改IP地址就可以进行转发。也正因为IP地址一样，所以源服务器的响应不需要转发回负载均衡服务器，可以直接转发给客户端，避免了负载均衡服务器的成为瓶颈。

这是一种三角传输模式，被称为直接路由。对于提供下载和视频服务的网站来说，直接路由避免了大量的网络传输数据经过负载均衡服务器。

这是目前大型网站使用最广负载均衡转发方式，在Linux平台可以使用的负载均衡服务器为 LVS（Linux Virtual Server）。





# 集群下的Session管理🌊

一个用户的Session信息如果存储在一个服务器上，那么当负载均衡器把用户的下一个请求转发到另一个服务器，由于服务器没有用户的Session信息，那么该用户就需要重新进行登录等操作。

## Sticky Session

Sticky Session（会话粘滞）需要配置负载均衡器，使得一个用户的所有请求都路由到同一个服务器，这样就可以把用户的Session存放在该服务器中。

缺点：

- 当服务器宕机时，将丢失该服务器上的所有Session。

<img src="http://store.secretcamp.cn/uPic/image-202103140957419922021031409574216156870629lJkQp9lJkQp.png" alt="image-20210314095741992" style="zoom:50%;" />



## Session Replication

Session Replication（会话复制）在服务器之间进行同步操作，每个服务器都有所有用户的Session信息，因此用户可以向任何一个服务器进行请求。

缺点：

- 占用过多内存；
- 同步过程占用网络带宽以及服务器处理器时间。

<img src="http://store.secretcamp.cn/uPic/image-20210314095722885202103140957231615687043xG0ZZnxG0ZZn.png" alt="image-20210314095722885" style="zoom:50%;" />



## Session Server

使用一个单独的服务器存储Session数据，可以使用传统的 MySQL ，也使用 Redis 或者 Memcached 这种内存型数据库。

优点：

- 为了使得大型网站具有伸缩性，集群中的应用服务器通常需要保持无状态，那么应用服务器不能存储用户的会话信息。Session Server 将用户的会话信息单独进行存储，从而保证了应用服务器的无状态。

缺点：

- 需要去实现存取Session的代码。

